---
title: 我的家庭网络架设日志
date: 2019-09-29 23:35:08
updated: 2019-09-30 18:42:08
categories: 折腾
tags: [家庭组网, VLAN, 光猫, 路由器]
---

家里的自建网络在近三年经历了多次升级改造，目前已稳定下来，并正常运行一年有余。多次改造过程中，搜索、学习了不少网络底层知识，现在大致记录一下。
先看看目前我家里的网络拓扑图吧：
![我的家庭网络拓扑图](/gallery/我的家庭网络拓扑图.png)

## 硬件介绍
* 图中的光猫是自行更换的（电商平台有售，8245C2改H版的也行，网上有[更换教程](https://post.smzdm.com/p/738418/)），主要看中了其转发性能和LAN四口千兆，运行也远比电信送的渣渣稳定可靠，三年时间中没有出过任何故障，而周围邻居用的总在掉线。电信在近期对其网络设备进行了升级，接收到的光信号又升了几个dB（-20dB -> -14dB），就更稳了。现在只希望能尽快提供IPV6吧。
* 路由器+无线AP用的是原思科子品牌Linksys的 WRT1900ACS。WRT系列在路由器固件开源史上可谓无出其右，对OpenWRT等开源固件的支持非常好，这是我最看重的地方。目前这个路由器用的固件是我自行编译的，虽说各种社区里的网友共享固件也能满足需求，但我有新版~~强迫症~~情结，也不喜欢路由器里有用不到的功能，所以就自己定制了。这里强烈推荐一下某大神的[OpenWRT编译仓库](https://github.com/coolsnowwolf/lede)，该repo集成了多种路由器的编译配置，喜欢的学习一下怎么弄吧。
* IPTV机顶盒是电信送的，看直播方便些。可能你已看出来一个细节：IPTV没有接到光猫上，而是通过了路由器，具体怎么实现的下面在VLAN小节里会介绍。
* 无线WIFI方面，目前家里其实是主用5G的，速度快干扰少，小户型的信号衰减也没有那么厉害，完全堪用。2.4G给老设备和智能家居设备使用。
* NAS是用一台2009年的老笔记本来充当的，10年了舍不得丢，换过SSD，只用AC电源，希望还能再撑10年。系统仍用Win 7，7*24运行中，异常稳定。没刷NAS专用系统，感觉Win完全够用，也很方便，要啥有啥（也许是因为太懒，换系统毕竟有成本啊）。

## 家庭VLAN设置
熟悉网络架构的同学应该清楚，VLAN是二层（数据链路层）协议，对传统LAN进行了进一步的分割，可以在同一物理网络上架设多个虚拟的LAN。光网改造后，各电信服务商在家庭接入网这块，也全面应用了VLAN技术，主要是对远程光猫控制、互联网接入、IPTV、IP电话等业务进行了VLAN隔离，保证QOS。较新的光猫设备都支持自行设置VLAN（一些型号可能需要破解超密，本文不介绍这方面的知识，请善用搜索），而一般的家庭路由器对VLAN的支持可能并不充分，需要刷固件。
细心的你可能也看到上面拓扑图中的一个细节，光猫和路由器之间的有线连接是双向箭头的，和其他的不一样。其实这里就是用到了VLAN，具体如下。
### 从需求说起
我家当时装修时，没考虑到家庭路由的位置问题，犯了个设计上的错误：所有房间的网口都接到玄关的弱电箱里了（这种情况应该是挺普遍的吧）。后来组网时发现，如果用光猫拨号，NAS、台式机、路由器平行接入光猫，很可能造成光猫转发压力大，过热不稳定（更换光猫前），也不便于台式机通过路由器科学上网；而如果光猫桥接，在路由器PPPoE拨号（可避免多一层网络，多一层转发），NAS和台式机又要有线接入，这样使用传统方法组网，路由就必须放在弱电箱那里（不走明线的话），离WIFI使用者远，信号衰减厉害。所以，路由器最好能放在位于家庭中心的客厅电视柜上，利用那里唯一的网口连接光猫，而NAS和台式机通过光猫连接路由器，如拓扑图中那样。
### 现有方案
通过搜索，网友分享的方案主要有以下两个（搜索**单臂路由**）：
> 方案1：在弱电箱中加入一个带VLAN功能的交换机，光猫、路由器、NAS、台式机都接入这个交换机，通过VLAN分割流量。
> 方案2: 利用光猫本身的VLAN交换功能，对WAN和LAN流量进行分割。

本着~~穷逼~~一贯的极简设计、物尽其用原则，当然选方案2啦。
### 光猫VLAN设置
#### 光猫WLAN配置
![](/gallery/15698166127923.jpg)

* 首先是内网VLAN设置，这里分配了VLAN-1给光猫、路由器、NAS和台式机，先绑定了NAS和台式机接入的LAN1、LAN3端口；LAN2为路由器接入端口，需要绑定多个VLAN（即trunk口），故不勾选；LAN4无设备接入，也不勾选。

![](/gallery/15698170131525.jpg)

* WAN外网桥接设置，分配的VLAN ID为电信局方下发的，一定要配置对。换光猫前要从老猫那里记录下来（另外要记录的还有其他业务的VLAN ID和设备LOID，即逻辑ID）。这里没有绑定任何端口，会在后面进行trunk绑定。

![](/gallery/15698174875130.jpg)

* IPTV设置，同样，这里的VLAN ID为电信指定好的，不能更改为其他的ID。IPTV会用到组播，设置一下所在地区的组播VLAN。

#### 光猫LAN设置
![](/gallery/15698176862757.jpg)

* 光猫LAN端口工作模式，这里只需要勾选LAN2端口，LAN1和LAN3已做过绑定，所以默认就已勾选。

![](/gallery/15698180048699.jpg)

* 光猫LAN IP设置，地址设为路由器的内网IP段中的某个未使用的静态地址，掩码保持一致，这样可以方便路由器内网设备登录到处于桥接模式的光猫。

![](/gallery/15698183127247.jpg)

* 光猫DHCP设置，因光猫只作桥接，无路由转发职责，关闭所有DHCP功能即可。

#### VLAN trunk端口设置

![](/gallery/15698185865091.jpg)

* **重点**来了，在光猫*路由*设置栏这里，需对LAN2端口进行多重VLAN绑定，上图中同时绑定了三组，分别为：
  - 路由器侧WAN／光猫侧WAN
  - 路由器侧IPTV／光猫侧IPTV
  - 路由器侧LAN／光猫侧LAN

至此光猫VLAN已设置完成。

### 路由器VLAN设置
#### 路由器交换机设置
![](/gallery/15698192286427.jpg)

* 此步同样**关键**。如图，在路由器的*交换机*设置栏中，对`VLAN ID 1-3`进行如下分配：
 - 内网`1`绑定网卡eth0，以及除接有IPTV机顶盒的LAN3外的所有端口（包括WAN端口）；
 - 外网`2`绑定网卡eth1，以及WAN端口；
 - IPTV网`3`绑定接有IPTV机顶盒的LAN3，及WAN端口。

  其中，可以看到，因WAN端口为trunk口，与连接的光猫处于多个VLAN中，故必须设为打VLAN ID标签的模式`tagged`，以区分不同流量，而其他端口连接的设备已离开VLAN，故设为`untagged`。另外有个小细节：IPTV所在的VLAN `3` 未分配到网卡上，因为其只需二层转发，不用动IP层，不划到LAN中，防火墙能少处理一点流量吧。

#### 路由器接口设置
![](/gallery/15698200530052.jpg)

* WAN接口这里，在*物理设置*中须绑定`eth1.2`接口（即*交换机*中的`eth1`网卡和VLAN `2`），然后在*基本设置*中设定好PPPoE拨号即可，此时可测试一下能否拨号成功。

![](/gallery/15698206303338.jpg)

* 如图，LAN接口同样须设置接口绑定，只是绑定的是`eth0.1`，还有两个无线WIFI，可开启组播（主要为了IPTV，不开应该也行，毕竟IPTV不在LAN中）。

![](/gallery/15698217111214.jpg)

* LAN基本设置，注意IP地址和掩码与上面光猫LAN侧的对应，保持在同一内网网段即可。

![](/gallery/15698212854478.jpg)

* LAN接口的DHCP服务器设置中，开始IP可设置到高地址段，低地址段预留给手动配置静态IP的设备，如光猫的LAN地址、NAS和台式机。另外提一句，路由器的DHCP协议包一般情况下无法跨越光猫，即使设置好了VLAN和网段（可能需要光猫支持LAN侧的DHCP中继才行吧），故NAS和台式机是手动配置的静态IP，同时也便于内网访问及做静态ARP绑定。

## 问题与思考

1. 单臂路由是否影响网速？
 - 对于这个问题，我上网找过相关资料，发现在家用环境下，网速基本无影响。这里要理解的是`1000M baseT 全双工`这个概念，全双工与单工的区别就在于，其可支持网络两端同时以标称速度进行收发包（上下行带宽均可达到1000M），而单工要达到标称速度只能一端发，另一端收，不能两端同时收发，否则速度就会减半。所以即使用到了单臂路由，非极端情况（典型家用情境），内网带宽扔可保持全千兆，与非单臂路由情况基本无差，完全够用。当然，这里的分析都是基于内网各条线路、接口均能达到千兆双工的前提，若达不到，建议有条件就升级线路，用好点的线（超五类即可）+ 质量过关的水晶头和网口面板，自己动手把关，避免在物理层出现降速瓶颈。

至此，所有设置已完成，可以欢快的上网了。
接下来，关于家庭网络搭建，会继续介绍关于DDNS和WOL的内容，干货多多，敬请期待。

